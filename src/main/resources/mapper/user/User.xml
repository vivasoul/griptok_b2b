<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.griptk.b2b.user.mapper.UserMapper">

	<select id="checkUserId" parameterType="String" resultType="Integer">
		SELECT count(*) FROM tb_user
		WHERE user_id = #{user_id}
	</select>
	
	<select id="checkCompanyNm" parameterType="String" resultType="Integer">
		SELECT count(*) FROM tb_user
		WHERE company_nm = #{company_nm}
	</select>
	
	<select id="checkBizRegNumber" parameterType="String" resultType="Integer">
		SELECT count(*) FROM tb_user
		WHERE biz_reg_number = #{biz_reg_number}
	</select>
	
	<insert id="insertImgInfo" parameterType="com.griptk.b2b.user.domain.UserVO" >
		INSERT INTO tb_img_file_info(
			file_nm,
			file_path,
			file_size,
			reg_dt,
			file_format,
			img_width,
			img_height
		)
		VALUES(
			#{file_nm},
			#{file_path},
			#{file_size},
			now(),
			#{file_format},
			#{img_width},
			#{img_height}
		)
		
	</insert>
	
	<select id="getImgNo" resultType="Integer">
		SELECT LAST_INSERT_ID();
	</select>
	
	<select id="getUserInfo" parameterType="Integer" resultType="com.griptk.b2b.user.domain.UserVO">
		SELECT user_id, 
			u.company_nm,
			u.biz_reg_number,
			u.ceo_nm,
			u.biz_category,
			u.biz_addr_1,
			u.biz_addr_2,
			u.contact_tel,
			u.tax_email,
			u.manager_nm,
			u.manager_tel,
			u.manager_email,
			u.post_code,
			u.reg_dt,
			u.upd_dt,
			u.biz_img_no,
			i.file_nm
		FROM
			tb_user u
		INNER JOIN
			tb_img_file_info i
		ON u.biz_img_no = i.img_no
		WHERE
			u.user_no = #{user_no}
	</select>
	
	<insert id="signUpUser" parameterType="com.griptk.b2b.user.domain.UserVO" >
		INSERT INTO tb_user(
			user_id, 
			company_nm,
			biz_reg_number,
			ceo_nm,
			biz_category,
			post_code,
			biz_addr_1,
			biz_addr_2,
			contact_tel,
			tax_email,
			manager_nm,
			manager_tel,
			manager_email,
			reg_dt,
			upd_dt,
			biz_img_no 
		)
		VALUES (
			#{user_id}, 
			#{company_nm},
			#{biz_reg_number},
			#{ceo_nm},
			'',
			#{post_code},
			#{biz_addr_1},
			#{biz_addr_2},
			#{contact_tel},
			#{tax_email},
			#{manager_nm},
			#{manager_tel},
			#{manager_email},
			now(),
			now(),
			#{biz_img_no} 
		)
	</insert>
	
	<insert id="insertLoginInfo" parameterType="com.griptk.b2b.user.domain.UserVO">
		INSERT INTO tb_login(
			user_no,
			passwd,
			reg_dt,
			upd_dt,
			aprv_status
		)VALUES(
			(SELECT user_no FROM tb_user WHERE user_id = #{user_id}),
			#{passwd},
			now(),
			now(),
			"N"
		)
	</insert>
	
	<insert id="setPasswd" parameterType="com.griptk.b2b.user.domain.UserVO">
		UPDATE tb_login
		SET passwd = #{passwd}
		WHERE user_no = #{user_no}
	</insert>
	
	<insert id="insertWithdrawal" parameterType="com.griptk.b2b.user.domain.WithdrawalVO">
		INSERT INTO tb_withdrawal_hist(
			user_no,
			code,
			remark,
			reg_dt
		)VALUES(
			(SELECT user_no FROM tb_user WHERE user_id = #{user_id}),
			#{code},
			#{remark},
			now()
		)
	</insert>
	
	<update id="updateStatus" parameterType="com.griptk.b2b.user.domain.WithdrawalVO">
		UPDATE 
			tb_login
		SET
			aprv_status='W'
		WHERE 
			user_no = (SELECT user_no FROM tb_user WHERE user_id = #{user_id})
	</update>
	
	<select id="getUserLoginInfo" parameterType="String" resultType="com.griptk.b2b.user.domain.UserVO">
		SELECT l.aprv_status, u.user_no, l.passwd FROM tb_user u
		INNER JOIN tb_login l
		ON u.user_no = l.user_no
		WHERE user_id= #{user_id}
	</select>
	
	<select id="getPassword" parameterType="Integer" resultType="String">
		SELECT l.passwd FROM tb_login l
		WHERE user_no= #{user_no}
	</select>
	
	<select id="login" parameterType="com.griptk.b2b.user.domain.UserVO" resultType="Integer">
		SELECT count(*) FROM tb_user u
		INNER JOIN tb_login l
		ON u.user_no = l.user_no
		WHERE user_id= #{user_id}
        AND passwd = #{passwd}
	</select>
	
	<select id="findId" parameterType="com.griptk.b2b.user.domain.UserVO" resultType="String">
		SELECT user_id FROM tb_user
		WHERE ceo_nm = #{ceo_nm}
		 <if test="contact_tel != null">
	        AND contact_tel = #{contact_tel}
	    </if>
	    <if test="tax_email != null">
	        AND tax_email = #{tax_email}
	    </if>
	</select>
	
	<select id="findPasswd" parameterType="com.griptk.b2b.user.domain.UserVO" resultType="com.griptk.b2b.user.domain.UserVO">
		SELECT u.user_no, l.passwd, u.tax_email FROM tb_user u
		INNER JOIN tb_login l
		ON u.user_no = l.user_no
		WHERE user_id= #{user_id}
		AND ceo_nm = #{ceo_nm}
		<if test="contact_tel != null">
	        AND contact_tel = #{contact_tel}
	    </if>
	    <if test="tax_email != null">
	        AND tax_email = #{tax_email}
	    </if>
	</select>
	
</mapper>