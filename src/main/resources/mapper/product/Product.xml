<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.griptk.b2b.product.mapper.ProductMapper">
	<select id="listNewProducts" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		WHERE 1=1
		AND a.is_new = 'Y'
		ORDER BY a.reg_dt desc
		LIMIT 5
	</select>
	
	<select id="listBestProducts" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		WHERE 1=1
		AND a.is_best = 'Y'
		ORDER BY a.reg_dt desc
		LIMIT 5
	</select>
	
	<select id="listDcProducts" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			ROUND(a.sales_price*0.9,-2) AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		WHERE 1=1
		AND a.is_dc = 'Y'
		${order_by}
		LIMIT #{start}, #{limit}
	</select>	
	
	<select id="listProducts" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		${order_by}
		LIMIT #{start}, #{limit}
	</select>	
	
	<select id="listProducts_C" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		INNER JOIN tb_product_category c ON a.category_no = c.category_no
		WHERE 1=1
		AND c.craft_no = #{id}
		${order_by}
		LIMIT #{start}, #{limit}
	</select>
	
	<select id="listProducts_CC" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		WHERE 1=1
		AND a.category_no = #{id}
		${order_by}
		LIMIT #{start}, #{limit}
	</select>
	
	<select id="listProducts_B" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		INNER JOIN tb_product_category c ON a.category_no = c.category_no
		INNER JOIN tb_brand_type d ON c.brand_no = d.brand_no
		WHERE 1=1
		AND d.p_brand_no = #{id}	
		${order_by}
		LIMIT #{start}, #{limit}
	</select>
	
	<select id="listProducts_BB" parameterType="com.griptk.b2b.common.domain.PageLabelVO" resultType="com.griptk.b2b.product.domain.ProductVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price,
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format) AS thumb_img 
		FROM tb_product a
		INNER JOIN tb_img_file_info b ON a.thumb_img_no = b.img_no
		INNER JOIN tb_product_category c ON a.category_no = c.category_no
		WHERE 1=1
		AND c.brand_no = #{id}
		${order_by}
		LIMIT #{start}, #{limit}
	</select>				
	
	<select id="getAllCounts" resultType="Int">
		SELECT COUNT(*) AS cnt FROM tb_product
	</select>	
	<select id="getDCCounts" resultType="Int">
		SELECT COUNT(*) AS cnt FROM tb_product WHERE is_dc = 'Y'
	</select>	
	<!-- craft -->
	<select id="getPageLabel_C" parameterType="Int" resultType="com.griptk.b2b.common.domain.PageLabelVO">
		WITH CTE AS (
			SELECT CONCAT('(',COUNT(*),')') AS cnt_str FROM tb_product a
			INNER JOIN tb_product_category b ON a.category_no = b.category_no
			INNER JOIN tb_craft_type c ON b.craft_no = c.craft_no
			WHERE 1=1
			AND c.craft_no = #{craft_no}
		)
		SELECT 
			craft_nm AS `title`,
			CONCAT('홈 > ',craft_nm,cnt_str) AS `path`
		FROM tb_craft_type a CROSS JOIN CTE b
		WHERE 1=1
		AND craft_no = #{craft_no}		
	</select>
	<!-- craft > category -->
	<select id="getPageLabel_CC" parameterType="Int" resultType="com.griptk.b2b.common.domain.PageLabelVO">
		WITH CTE AS (
			SELECT CONCAT('(',COUNT(*),')') AS cnt_str FROM tb_product a
			INNER JOIN tb_product_category b ON a.category_no = b.category_no
			WHERE 1=1
			AND b.category_no = #{category_no}
		)
		SELECT 
			category_nm AS `title`,
			CONCAT('홈 > ',craft_nm,' > ', category_nm, cnt_str) AS `path`
		FROM tb_product_category a 
		INNER JOIN tb_craft_type b ON a.craft_no = b.craft_no
		CROSS JOIN CTE c
		WHERE 1=1
		AND a.category_no = #{category_no}
	</select>
	<!-- parent_brand -->
	<select id="getPageLabel_B" parameterType="Int" resultType="com.griptk.b2b.common.domain.PageLabelVO">
		WITH CTE AS (
			SELECT CONCAT('(',COUNT(*),')') AS cnt_str FROM tb_product a
			INNER JOIN tb_product_category b ON a.category_no = b.category_no
			INNER JOIN tb_brand_type c ON b.brand_no = c.brand_no
			WHERE 1=1
			AND c.p_brand_no = #{p_brand_no}
		)
		SELECT 
			a.brand_nm AS `title`,
			CONCAT('홈 > ',brand_nm,cnt_str) AS `path`
		FROM tb_brand_type a CROSS JOIN CTE b
		WHERE 1=1
		AND brand_no = #{p_brand_no}		
	</select>
	<!-- parent_brand > brand -->
	<select id="getPageLabel_BB" parameterType="Int" resultType="com.griptk.b2b.common.domain.PageLabelVO">
		WITH CTE AS (
			SELECT CONCAT('(',COUNT(*),')') AS cnt_str FROM tb_product a
			INNER JOIN tb_product_category b ON a.category_no = b.category_no
			INNER JOIN tb_brand_type c ON b.brand_no = c.brand_no
			WHERE 1=1
			AND c.brand_no = #{brand_no}
		)
		SELECT 
			a.brand_nm AS `title`,
			CONCAT('홈 > ',b.brand_nm,' > ',a.brand_nm, cnt_str) AS `path`
		FROM tb_brand_type a 
		INNER JOIN tb_brand_type b ON a.p_brand_no = b.brand_no
		CROSS JOIN CTE c
		WHERE 1=1
		AND a.brand_no = #{brand_no}		
	</select>
	
	<select id="getDetail" parameterType="Int" resultType="com.griptk.b2b.product.domain.ProductDetailVO">
		SELECT 
			a.product_id,
			a.title,
			a.retail_price,
			CASE a.is_dc WHEN 'Y' THEN ROUND(a.sales_price*0.9,-2) 
										 ELSE a.sales_price
			END AS sales_price
		FROM tb_product a 
		INNER JOIN tb_product_detail b ON a.product_id = b.product_id
		WHERE 1=1
		AND a.product_id = #{product_id}		
	</select>	
	
	<select id="getDetailImages" parameterType="Int" resultType="String">
		SELECT 
			CONCAT(b.file_path, '/', b.file_nm,'.',b.file_format)
		FROM tb_product_img a 
		INNER JOIN tb_img_file_info b ON a.img_no = b.img_no
		WHERE 1=1
		AND a.product_id = #{product_id}		
	</select>		
</mapper>